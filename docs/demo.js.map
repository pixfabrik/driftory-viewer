{"version":3,"sources":["node_modules/browser-pack/_prelude.js","node_modules/@dan503/load-js/index.js","src/demo/demo.ts","src/library/driftory.ts"],"names":[],"mappings":"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","file":"demo.js","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()","\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar alreadyCalledSources = [];\r\nvar awaitingCallbacks = {};\r\nvar addCallback = function (src, callback) {\r\n    if (awaitingCallbacks[src]) {\r\n        awaitingCallbacks[src].push(callback);\r\n    }\r\n    else {\r\n        awaitingCallbacks[src] = [callback];\r\n    }\r\n};\r\nfunction loadJS(src, callback) {\r\n    if (alreadyCalledSources.indexOf(src) < 0) {\r\n        alreadyCalledSources.push(src);\r\n        var script = document.createElement('script');\r\n        script.src = src;\r\n        script.onload = function () {\r\n            addCallback(src, callback);\r\n            for (var key in awaitingCallbacks) {\r\n                awaitingCallbacks[key].forEach(function (cb) { return cb(); });\r\n            }\r\n        };\r\n        document.head.appendChild(script);\r\n    }\r\n    else {\r\n        addCallback(src, callback);\r\n    }\r\n}\r\nexports.default = loadJS;\r\n","import Driftory from '../library/driftory';\r\n\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n  const nextButton = document.querySelector('.next-button');\r\n  const previousButton = document.querySelector('.previous-button');\r\n  const frameInfo = document.querySelector('.frame-info');\r\n\r\n  const driftory = new Driftory({\r\n    container: document.querySelector('.driftory-viewer-container'),\r\n    prefixUrl: 'https://cdn.jsdelivr.net/npm/openseadragon@2.4/build/openseadragon/images/',\r\n    onComicLoad: () => {\r\n      console.log('loaded!');\r\n    },\r\n    onFrameChange: ({ frameIndex = 0, isLastFrame }) => {\r\n      if (frameInfo) {\r\n        let text = `Frame ${frameIndex + 1}`;\r\n        if (isLastFrame) {\r\n          text += ' (last frame!)';\r\n        }\r\n\r\n        frameInfo.textContent = text;\r\n      }\r\n    }\r\n  });\r\n\r\n  nextButton?.addEventListener('click', () => {\r\n    driftory.goToNextFrame();\r\n  });\r\n\r\n  previousButton?.addEventListener('click', () => {\r\n    driftory.goToPreviousFrame();\r\n  });\r\n\r\n  fetch('comic.json')\r\n    .then(response => {\r\n      if (!response.ok) {\r\n        console.error(response);\r\n        throw new Error('Failed to load comic.json');\r\n      }\r\n\r\n      return response.json();\r\n    })\r\n    .then(json => {\r\n      // console.log(json);\r\n      driftory.openComic(json.comic);\r\n    })\r\n    .catch(error => console.error(error));\r\n});\r\n","import loadJs from '@dan503/load-js';\r\nimport { Comic } from '../../Comic.types';\r\nimport { OpenSeadragonType, ViewerType } from './openseadragon.types';\r\n\r\ninterface OsdRequest {\r\n  resolve: (value?: unknown) => void;\r\n  reject: (reason?: any) => void;\r\n}\r\n\r\nlet OpenSeadragon: OpenSeadragonType | undefined;\r\nlet osdRequest: OsdRequest | undefined;\r\n\r\ndeclare global {\r\n  interface Window {\r\n    OpenSeadragon: OpenSeadragonType;\r\n  }\r\n}\r\n\r\nconst osdPromise = new Promise((resolve, reject) => {\r\n  osdRequest = { resolve, reject };\r\n});\r\n\r\ntype Frame = any;\r\ntype Container = any;\r\ntype OnFrameChange = (params: { frameIndex?: number; isLastFrame: boolean }) => void;\r\ntype OnComicLoad = (params: {}) => void;\r\n\r\ninterface DriftoryArguments {\r\n  container: any;\r\n  onFrameChange: OnFrameChange;\r\n  onComicLoad: OnComicLoad;\r\n  prefixUrl: string;\r\n}\r\n\r\nexport default class Driftory {\r\n  container: Container;\r\n  onFrameChange: OnFrameChange;\r\n  onComicLoad: OnComicLoad;\r\n  frames: Array<Frame> = [];\r\n  frameIndex?: number = -1;\r\n  lastScrollTime: number = 0;\r\n  scrollDelay: number = 2000;\r\n  viewer?: ViewerType;\r\n\r\n  constructor(args: DriftoryArguments) {\r\n    this.container = args.container;\r\n    this.onFrameChange = args.onFrameChange;\r\n    this.onComicLoad = args.onComicLoad;\r\n\r\n    // TODO: Make this more robust so it handles multiple viewers being created at the same time.\r\n    // Right now they would both load OSD since they would start before the other finished.\r\n    if (OpenSeadragon) {\r\n      this.initialize(args);\r\n    } else {\r\n      loadJs(\r\n        'https://cdn.jsdelivr.net/npm/openseadragon@2.4/build/openseadragon/openseadragon.min.js',\r\n        () => {\r\n          OpenSeadragon = window.OpenSeadragon;\r\n          this.initialize(args);\r\n          osdRequest?.resolve();\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  initialize({ container, prefixUrl }: DriftoryArguments) {\r\n    this.viewer =\r\n      OpenSeadragon &&\r\n      OpenSeadragon({\r\n        element: container,\r\n        prefixUrl: prefixUrl,\r\n        showNavigationControl: false,\r\n        maxZoomPixelRatio: 10,\r\n        gestureSettingsMouse: {\r\n          clickToZoom: false\r\n        }\r\n      });\r\n\r\n    if (this.viewer) {\r\n      // TODO: Maybe don't need to do this every frame.\r\n      this.viewer.addHandler('animation', () => {\r\n        const frameIndex = this.figureFrameIndex();\r\n        if (frameIndex !== -1 && frameIndex !== this.frameIndex) {\r\n          this.frameIndex = frameIndex;\r\n          if (this.onFrameChange) {\r\n            this.onFrameChange({\r\n              frameIndex,\r\n              isLastFrame: frameIndex === this.getFrameCount() - 1\r\n            });\r\n          }\r\n        }\r\n      });\r\n\r\n      this.viewer.addHandler('canvas-click', event => {\r\n        if (!event || !event.quick || !event.position || !this.viewer) {\r\n          return;\r\n        }\r\n\r\n        const point = this.viewer.viewport.pointFromPixel(event.position);\r\n        let foundIndex = -1;\r\n        const itemCount = this.viewer.world.getItemCount();\r\n\r\n        for (let i = 0; i < itemCount; i++) {\r\n          const item = this.viewer.world.getItemAt(i);\r\n          if (item.getBounds().containsPoint(point)) {\r\n            foundIndex = i;\r\n          }\r\n        }\r\n\r\n        if (foundIndex === -1) {\r\n          const realFrameIndex = this.figureFrameIndex();\r\n          if (realFrameIndex === -1 && this.frameIndex !== undefined) {\r\n            this.goToFrame(this.frameIndex);\r\n          } else {\r\n            this.goToNextFrame();\r\n          }\r\n        } else if (foundIndex === this.frameIndex) {\r\n          this.goToNextFrame();\r\n        } else {\r\n          this.goToFrame(foundIndex);\r\n        }\r\n      });\r\n\r\n      const originalScrollHandler = this.viewer.innerTracker.scrollHandler;\r\n      this.viewer.innerTracker.scrollHandler = event => {\r\n        if (\r\n          event.originalEvent.ctrlKey ||\r\n          event.originalEvent.altKey ||\r\n          event.originalEvent.metaKey\r\n        ) {\r\n          return originalScrollHandler.call(this.viewer?.innerTracker, event);\r\n        }\r\n\r\n        const now = Date.now();\r\n        // console.log(event.scroll, now, now - this.lastScrollTime);\r\n        if (now - this.lastScrollTime < this.scrollDelay) {\r\n          // Returning false stops the browser from scrolling itself.\r\n          return false;\r\n        }\r\n\r\n        this.lastScrollTime = now;\r\n        if (event.scroll < 0) {\r\n          this.goToNextFrame();\r\n        } else {\r\n          this.goToPreviousFrame();\r\n        }\r\n\r\n        // Returning false stops the browser from scrolling itself.\r\n        return false;\r\n      };\r\n\r\n      window.addEventListener('keydown', event => {\r\n        if (event.altKey || event.shiftKey || event.ctrlKey || event.metaKey) {\r\n          return;\r\n        }\r\n\r\n        if (event.key === 'ArrowRight' || event.key === 'ArrowDown' || event.key === ' ') {\r\n          this.goToNextFrame();\r\n        } else if (event.key === 'ArrowLeft' || event.key === 'ArrowUp') {\r\n          this.goToPreviousFrame();\r\n        } else {\r\n          return;\r\n        }\r\n\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n      });\r\n    }\r\n  }\r\n\r\n  openComic(comic: Comic) {\r\n    osdPromise.then(() => {\r\n      this.container.style.backgroundColor = comic.body.backgroundColor;\r\n\r\n      if (this.viewer) {\r\n        if (comic.body.frames) {\r\n          this.frames = comic.body.frames.map(frame => {\r\n            return (\r\n              OpenSeadragon &&\r\n              new OpenSeadragon.Rect(\r\n                frame.x - frame.width / 2,\r\n                frame.y - frame.height / 2,\r\n                frame.width,\r\n                frame.height\r\n              )\r\n            );\r\n          });\r\n        } else {\r\n          this.frames = comic.body.items.map(item => {\r\n            return (\r\n              OpenSeadragon &&\r\n              new OpenSeadragon.Rect(\r\n                item.x - item.width / 2,\r\n                item.y - item.height / 2,\r\n                item.width,\r\n                item.height\r\n              )\r\n            );\r\n          });\r\n        }\r\n\r\n        comic.body.items.forEach((item, i) => {\r\n          var success;\r\n\r\n          if (i === 0) {\r\n            success = () => this.goToFrame(0);\r\n          }\r\n\r\n          this.viewer?.addTiledImage({\r\n            x: item.x - item.width / 2,\r\n            y: item.y - item.height / 2,\r\n            width: item.width,\r\n            success: success,\r\n            tileSource: {\r\n              type: 'legacy-image-pyramid',\r\n              levels: [\r\n                {\r\n                  url: item.url,\r\n                  width: item.width,\r\n                  height: item.height\r\n                }\r\n              ]\r\n            }\r\n          });\r\n        });\r\n\r\n        if (this.onComicLoad) {\r\n          this.onComicLoad({});\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  goToFrame(index: number) {\r\n    var frame = this.frames[index];\r\n    var bufferFactor = 0.2;\r\n    var box = frame.clone();\r\n\r\n    box.width *= 1 + bufferFactor;\r\n    box.height *= 1 + bufferFactor;\r\n    box.x -= frame.width * bufferFactor * 0.5;\r\n    box.y -= frame.height * bufferFactor * 0.5;\r\n\r\n    this.viewer?.viewport.fitBounds(box);\r\n  }\r\n\r\n  getFrameIndex() {\r\n    return this.frameIndex;\r\n  }\r\n\r\n  figureFrameIndex() {\r\n    let bestIndex = -1;\r\n    let bestDistance = Infinity;\r\n    if (this.viewer) {\r\n      const viewportBounds = this.viewer.viewport.getBounds(true);\r\n      const viewportCenter = viewportBounds.getCenter();\r\n\r\n      for (let i = 0; i < this.frames.length; i++) {\r\n        const frame = this.frames[i];\r\n        if (frame.containsPoint(viewportCenter)) {\r\n          const distance = viewportCenter.squaredDistanceTo(frame.getCenter());\r\n          if (distance < bestDistance) {\r\n            bestDistance = distance;\r\n            bestIndex = i;\r\n          }\r\n        }\r\n      }\r\n\r\n      return bestIndex;\r\n    }\r\n  }\r\n\r\n  getFrameCount() {\r\n    return this.frames.length;\r\n  }\r\n\r\n  goToNextFrame() {\r\n    let index = this.getFrameIndex();\r\n    if (index !== undefined && index < this.frames.length - 1) {\r\n      this.goToFrame(index + 1);\r\n    }\r\n  }\r\n\r\n  goToPreviousFrame() {\r\n    let index = this.getFrameIndex();\r\n    if (index !== undefined && index > 0) {\r\n      this.goToFrame(index - 1);\r\n    }\r\n  }\r\n}\r\n"],"preExistingComment":"//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJub2RlX21vZHVsZXMvQGRhbjUwMy9sb2FkLWpzL2luZGV4LmpzIiwic3JjL2RlbW8vZGVtby50cyIsInNyYy9saWJyYXJ5L2RyaWZ0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FDQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7Ozs7Ozs7QUM5QkEsaUVBQTJDO0FBRTNDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxrQkFBa0IsRUFBRTtJQUM1QyxJQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQzFELElBQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUNsRSxJQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBRXhELElBQU0sUUFBUSxHQUFHLElBQUksa0JBQVEsQ0FBQztRQUM1QixTQUFTLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyw0QkFBNEIsQ0FBQztRQUMvRCxTQUFTLEVBQUUsNEVBQTRFO1FBQ3ZGLFdBQVcsRUFBRTtZQUNYLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDekIsQ0FBQztRQUNELGFBQWEsRUFBRSxVQUFDLEVBQStCO2dCQUE3QixrQkFBYyxFQUFkLFVBQVUsbUJBQUcsQ0FBQyxLQUFBLEVBQUUsV0FBVyxpQkFBQTtZQUMzQyxJQUFJLFNBQVMsRUFBRTtnQkFDYixJQUFJLElBQUksR0FBRyxZQUFTLFVBQVUsR0FBRyxDQUFDLENBQUUsQ0FBQztnQkFDckMsSUFB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QUFDO1NBQ2xCO0lBQ0gsQ0FBQztJQUVELGdDQUFhLEdBQWI7UUFDRSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQzVCLENBQUM7SUFFRCxnQ0FBYSxHQUFiO1FBQ0UsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ2pDLElBQUksS0FBSyxLQUFLLFNBQVMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3pELElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQzNCO0lBQ0gsQ0FBQztJQUVELG9DQUFpQixHQUFqQjtRQUNFLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNqQyxJQUFJLEtBQUssS0FBSyxTQUFTLElBQUksS0FBSyxHQUFHLENBQUMsRUFBRTtZQUNwQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztTQUMzQjtJQUNILENBQUM7SUFDSCxlQUFDO0FBQUQsQ0EvUEEsQUErUEMsSUFBQSIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uKCl7ZnVuY3Rpb24gcihlLG4sdCl7ZnVuY3Rpb24gbyhpLGYpe2lmKCFuW2ldKXtpZighZVtpXSl7dmFyIGM9XCJmdW5jdGlvblwiPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZTtpZighZiYmYylyZXR1cm4gYyhpLCEwKTtpZih1KXJldHVybiB1KGksITApO3ZhciBhPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIraStcIidcIik7dGhyb3cgYS5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGF9dmFyIHA9bltpXT17ZXhwb3J0czp7fX07ZVtpXVswXS5jYWxsKHAuZXhwb3J0cyxmdW5jdGlvbihyKXt2YXIgbj1lW2ldWzFdW3JdO3JldHVybiBvKG58fHIpfSxwLHAuZXhwb3J0cyxyLGUsbix0KX1yZXR1cm4gbltpXS5leHBvcnRzfWZvcih2YXIgdT1cImZ1bmN0aW9uXCI9PXR5cGVvZiByZXF1aXJlJiZyZXF1aXJlLGk9MDtpPHQubGVuZ3RoO2krKylvKHRbaV0pO3JldHVybiBvfXJldHVybiByfSkoKSIsIlwidXNlIHN0cmljdFwiO1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbnZhciBhbHJlYWR5Q2FsbGVkU291cmNlcyA9IFtdO1xyXG52YXIgYXdhaXRpbmdDYWxsYmFja3MgPSB7fTtcclxudmFyIGFkZENhbGxiYWNrID0gZnVuY3Rpb24gKHNyYywgY2FsbGJhY2spIHtcclxuICAgIGlmIChhd2FpdGluZ0NhbGxiYWNrc1tzcmNdKSB7XHJcbiAgICAgICAgYXdhaXRpbmdDYWxsYmFja3Nbc3JjXS5wdXNoKGNhbGxiYWNrKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIGF3YWl0aW5nQ2FsbGJhY2tzW3NyY10gPSBbY2FsbGJhY2tdO1xyXG4gICAgfVxyXG59O1xyXG5mdW5jdGlvbiBsb2FkSlMoc3JjLCBjYWxsYmFjaykge1xyXG4gICAgaWYgKGFscmVhZHlDYWxsZWRTb3VyY2VzLmluZGV4T2Yoc3JjKSA8IDApIHtcclxuICAgICAgICBhbHJlYWR5Q2FsbGVkU291cmNlcy5wdXNoKHNyYyk7XHJcbiAgICAgICAgdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xyXG4gICAgICAgIHNjcmlwdC5zcmMgPSBzcmM7XHJcbiAgICAgICAgc2NyaXB0Lm9ubG9hZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgYWRkQ2FsbGJhY2soc3JjLCBjYWxsYmFjayk7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBhd2FpdGluZ0NhbGxiYWNrcykge1xyXG4gICAgICAgICAgICAgICAgYXdhaXRpbmdDYWxsYmFja3Nba2V5XS5mb3JFYWNoKGZ1bmN0aW9uIChjYikgeyByZXR1cm4gY2IoKTsgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIGFkZENhbGxiYWNrKHNyYywgY2FsbGJhY2spO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydHMuZGVmYXVsdCA9IGxvYWRKUztcclxuIiwiaW1wb3J0IERyaWZ0b3J5IGZyb20gJy4uL2xpYnJhcnkvZHJpZnRvcnknO1xyXG5cclxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsICgpID0+IHtcclxuICBjb25zdCBuZXh0QnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm5leHQtYnV0dG9uJyk7XHJcbiAgY29uc3QgcHJldmlvdXNCdXR0b24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcucHJldmlvdXMtYnV0dG9uJyk7XHJcbiAgY29uc3QgZnJhbWVJbmZvID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmZyYW1lLWluZm8nKTtcclxuXHJcbiAgY29uc3QgZHJpZnRvcnkgPSBuZXcgRHJpZnRvcnkoe1xyXG4gICAgY29udGFpbmVyOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZHJpZnRvcnktdmlld2VyLWNvbnRhaW5lcicpLFxyXG4gICAgcHJlZml4VXJsOiAnaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9vcGVuc2VhZHJhZ29uQDIuNC9idWlsZC9vcGVuc2VhZHJhZ29uL2ltYWdlcy8nLFxyXG4gICAgb25Db21pY0xvYWQ6ICgpID0+IHtcclxuICAgICAgY29uc29sZS5sb2coJ2xvYWRlZCEnKTtcclxuICAgIH0sXHJcbiAgICBvbkZyYW1lQ2hhbmdlOiAoeyBmcmFtZUluZGV4ID0gMCwgaXNMYXN0RnJhbWUgfSkgPT4ge1xyXG4gICAgICBpZiAoZnJhbWVJbmZvKSB7XHJcbiAgICAgICAgbGV0IHRleHQgPSBgRnJhbWUgJHtmcmFtZUluZGV4ICsgMX1gO1xyXG4gICAgICAgIGlmIChpc0xhc3RGcmFtZSkge1xyXG4gICAgICAgICAgdGV4dCArPSAnIChsYXN0IGZyYW1lISknO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZnJhbWVJbmZvLnRleHRDb250ZW50ID0gdGV4dDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICBuZXh0QnV0dG9uPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcclxuICAgIGRyaWZ0b3J5LmdvVG9OZXh0RnJhbWUoKTtcclxuICB9KTtcclxuXHJcbiAgcHJldmlvdXNCdXR0b24/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgZHJpZnRvcnkuZ29Ub1ByZXZpb3VzRnJhbWUoKTtcclxuICB9KTtcclxuXHJcbiAgZmV0Y2goJ2NvbWljLmpzb24nKVxyXG4gICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xyXG4gICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihyZXNwb25zZSk7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gbG9hZCBjb21pYy5qc29uJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XHJcbiAgICB9KVxyXG4gICAgLnRoZW4oanNvbiA9PiB7XHJcbiAgICAgIC8vIGNvbnNvbGUubG9nKGpzb24pO1xyXG4gICAgICBkcmlmdG9yeS5vcGVuQ29taWMoanNvbi5jb21pYyk7XHJcbiAgICB9KVxyXG4gICAgLmNhdGNoKGVycm9yID0+IGNvbnNvbGUuZXJyb3IoZXJyb3IpKTtcclxufSk7XHJcbiIsImltcG9ydCBsb2FkSnMgZnJvbSAnQGRhbjUwMy9sb2FkLWpzJztcclxuaW1wb3J0IHsgQ29taWMgfSBmcm9tICcuLi8uLi9Db21pYy50eXBlcyc7XHJcbmltcG9ydCB7IE9wZW5TZWFkcmFnb25UeXBlLCBWaWV3ZXJUeXBlIH0gZnJvbSAnLi9vcGVuc2VhZHJhZ29uLnR5cGVzJztcclxuXHJcbmludGVyZmFjZSBPc2RSZXF1ZXN0IHtcclxuICByZXNvbHZlOiAodmFsdWU/OiB1bmtub3duKSA9PiB2b2lkO1xyXG4gIHJlamVjdDogKHJlYXNvbj86IGFueSkgPT4gdm9pZDtcclxufVxyXG5cclxubGV0IE9wZW5TZWFkcmFnb246IE9wZW5TZWFkcmFnb25UeXBlIHwgdW5kZWZpbmVkO1xyXG5sZXQgb3NkUmVxdWVzdDogT3NkUmVxdWVzdCB8IHVuZGVmaW5lZDtcclxuXHJcbmRlY2xhcmUgZ2xvYmFsIHtcclxuICBpbnRlcmZhY2UgV2luZG93IHtcclxuICAgIE9wZW5TZWFkcmFnb246IE9wZW5TZWFkcmFnb25UeXBlO1xyXG4gIH1cclxufVxyXG5cclxuY29uc3Qgb3NkUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICBvc2RSZXF1ZXN0ID0geyByZXNvbHZlLCByZWplY3QgfTtcclxufSk7XHJcblxyXG50eXBlIEZyYW1lID0gYW55O1xyXG50eXBlIENvbnRhaW5lciA9IGFueTtcclxudHlwZSBPbkZyYW1lQ2hhbmdlID0gKHBhcmFtczogeyBmcmFtZUluZGV4PzogbnVtYmVyOyBpc0xhc3RGcmFtZTogYm9vbGVhbiB9KSA9PiB2b2lkO1xyXG50eXBlIE9uQ29taWNMb2FkID0gKHBhcmFtczoge30pID0+IHZvaWQ7XHJcblxyXG5pbnRlcmZhY2UgRHJpZnRvcnlBcmd1bWVudHMge1xyXG4gIGNvbnRhaW5lcjogYW55O1xyXG4gIG9uRnJhbWVDaGFuZ2U6IE9uRnJhbWVDaGFuZ2U7XHJcbiAgb25Db21pY0xvYWQ6IE9uQ29taWNMb2FkO1xyXG4gIHByZWZpeFVybDogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEcmlmdG9yeSB7XHJcbiAgY29udGFpbmVyOiBDb250YWluZXI7XHJcbiAgb25GcmFtZUNoYW5nZTogT25GcmFtZUNoYW5nZTtcclxuICBvbkNvbWljTG9hZDogT25Db21pY0xvYWQ7XHJcbiAgZnJhbWVzOiBBcnJheTxGcmFtZT4gPSBbXTtcclxuICBmcmFtZUluZGV4PzogbnVtYmVyID0gLTE7XHJcbiAgbGFzdFNjcm9sbFRpbWU6IG51bWJlciA9IDA7XHJcbiAgc2Nyb2xsRGVsYXk6IG51bWJlciA9IDIwMDA7XHJcbiAgdmlld2VyPzogVmlld2VyVHlwZTtcclxuXHJcbiAgY29uc3RydWN0b3IoYXJnczogRHJpZnRvcnlBcmd1bWVudHMpIHtcclxuICAgIHRoaXMuY29udGFpbmVyID0gYXJncy5jb250YWluZXI7XHJcbiAgICB0aGlzLm9uRnJhbWVDaGFuZ2UgPSBhcmdzLm9uRnJhbWVDaGFuZ2U7XHJcbiAgICB0aGlzLm9uQ29taWNMb2FkID0gYXJncy5vbkNvbWljTG9hZDtcclxuXHJcbiAgICAvLyBUT0RPOiBNYWtlIHRoaXMgbW9yZSByb2J1c3Qgc28gaXQgaGFuZGxlcyBtdWx0aXBsZSB2aWV3ZXJzIGJlaW5nIGNyZWF0ZWQgYXQgdGhlIHNhbWUgdGltZS5cclxuICAgIC8vIFJpZ2h0IG5vdyB0aGV5IHdvdWxkIGJvdGggbG9hZCBPU0Qgc2luY2UgdGhleSB3b3VsZCBzdGFydCBiZWZvcmUgdGhlIG90aGVyIGZpbmlzaGVkLlxyXG4gICAgaWYgKE9wZW5TZWFkcmFnb24pIHtcclxuICAgICAgdGhpcy5pbml0aWFsaXplKGFyZ3MpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbG9hZEpzKFxyXG4gICAgICAgICdodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL29wZW5zZWFkcmFnb25AMi40L2J1aWxkL29wZW5zZWFkcmFnb24vb3BlbnNlYWRyYWdvbi5taW4uanMnLFxyXG4gICAgICAgICgpID0+IHtcclxuICAgICAgICAgIE9wZW5TZWFkcmFnb24gPSB3aW5kb3cuT3BlblNlYWRyYWdvbjtcclxuICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZShhcmdzKTtcclxuICAgICAgICAgIG9zZFJlcXVlc3Q/LnJlc29sdmUoKTtcclxuICAgICAgICB9XHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpbml0aWFsaXplKHsgY29udGFpbmVyLCBwcmVmaXhVcmwgfTogRHJpZnRvcnlBcmd1bWVudHMpIHtcclxuICAgIHRoaXMudmlld2VyID1cclxuICAgICAgT3BlblNlYWRyYWdvbiAmJlxyXG4gICAgICBPcGVuU2VhZHJhZ29uKHtcclxuICAgICAgICBlbGVtZW50OiBjb250YWluZXIsXHJcbiAgICAgICAgcHJlZml4VXJsOiBwcmVmaXhVcmwsXHJcbiAgICAgICAgc2hvd05hdmlnYXRpb25Db250cm9sOiBmYWxzZSxcclxuICAgICAgICBtYXhab29tUGl4ZWxSYXRpbzogMTAsXHJcbiAgICAgICAgZ2VzdHVyZVNldHRpbmdzTW91c2U6IHtcclxuICAgICAgICAgIGNsaWNrVG9ab29tOiBmYWxzZVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcblxyXG4gICAgaWYgKHRoaXMudmlld2VyKSB7XHJcbiAgICAgIC8vIFRPRE86IE1heWJlIGRvbid0IG5lZWQgdG8gZG8gdGhpcyBldmVyeSBmcmFtZS5cclxuICAgICAgdGhpcy52aWV3ZXIuYWRkSGFuZGxlcignYW5pbWF0aW9uJywgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZyYW1lSW5kZXggPSB0aGlzLmZpZ3VyZUZyYW1lSW5kZXgoKTtcclxuICAgICAgICBpZiAoZnJhbWVJbmRleCAhPT0gLTEgJiYgZnJhbWVJbmRleCAhPT0gdGhpcy5mcmFtZUluZGV4KSB7XHJcbiAgICAgICAgICB0aGlzLmZyYW1lSW5kZXggPSBmcmFtZUluZGV4O1xyXG4gICAgICAgICAgaWYgKHRoaXMub25GcmFtZUNoYW5nZSkge1xyXG4gICAgICAgICAgICB0aGlzLm9uRnJhbWVDaGFuZ2Uoe1xyXG4gICAgICAgICAgICAgIGZyYW1lSW5kZXgsXHJcbiAgICAgICAgICAgICAgaXNMYXN0RnJhbWU6IGZyYW1lSW5kZXggPT09IHRoaXMuZ2V0RnJhbWVDb3VudCgpIC0gMVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdGhpcy52aWV3ZXIuYWRkSGFuZGxlcignY2FudmFzLWNsaWNrJywgZXZlbnQgPT4ge1xyXG4gICAgICAgIGlmICghZXZlbnQgfHwgIWV2ZW50LnF1aWNrIHx8ICFldmVudC5wb3NpdGlvbiB8fCAhdGhpcy52aWV3ZXIpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHBvaW50ID0gdGhpcy52aWV3ZXIudmlld3BvcnQucG9pbnRGcm9tUGl4ZWwoZXZlbnQucG9zaXRpb24pO1xyXG4gICAgICAgIGxldCBmb3VuZEluZGV4ID0gLTE7XHJcbiAgICAgICAgY29uc3QgaXRlbUNvdW50ID0gdGhpcy52aWV3ZXIud29ybGQuZ2V0SXRlbUNvdW50KCk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaXRlbUNvdW50OyBpKyspIHtcclxuICAgICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLnZpZXdlci53b3JsZC5nZXRJdGVtQXQoaSk7XHJcbiAgICAgICAgICBpZiAoaXRlbS5nZXRCb3VuZHMoKS5jb250YWluc1BvaW50KHBvaW50KSkge1xyXG4gICAgICAgICAgICBmb3VuZEluZGV4ID0gaTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChmb3VuZEluZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgY29uc3QgcmVhbEZyYW1lSW5kZXggPSB0aGlzLmZpZ3VyZUZyYW1lSW5kZXgoKTtcclxuICAgICAgICAgIGlmIChyZWFsRnJhbWVJbmRleCA9PT0gLTEgJiYgdGhpcy5mcmFtZUluZGV4ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5nb1RvRnJhbWUodGhpcy5mcmFtZUluZGV4KTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZ29Ub05leHRGcmFtZSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoZm91bmRJbmRleCA9PT0gdGhpcy5mcmFtZUluZGV4KSB7XHJcbiAgICAgICAgICB0aGlzLmdvVG9OZXh0RnJhbWUoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5nb1RvRnJhbWUoZm91bmRJbmRleCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IG9yaWdpbmFsU2Nyb2xsSGFuZGxlciA9IHRoaXMudmlld2VyLmlubmVyVHJhY2tlci5zY3JvbGxIYW5kbGVyO1xyXG4gICAgICB0aGlzLnZpZXdlci5pbm5lclRyYWNrZXIuc2Nyb2xsSGFuZGxlciA9IGV2ZW50ID0+IHtcclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICBldmVudC5vcmlnaW5hbEV2ZW50LmN0cmxLZXkgfHxcclxuICAgICAgICAgIGV2ZW50Lm9yaWdpbmFsRXZlbnQuYWx0S2V5IHx8XHJcbiAgICAgICAgICBldmVudC5vcmlnaW5hbEV2ZW50Lm1ldGFLZXlcclxuICAgICAgICApIHtcclxuICAgICAgICAgIHJldHVybiBvcmlnaW5hbFNjcm9sbEhhbmRsZXIuY2FsbCh0aGlzLnZpZXdlcj8uaW5uZXJUcmFja2VyLCBldmVudCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGV2ZW50LnNjcm9sbCwgbm93LCBub3cgLSB0aGlzLmxhc3RTY3JvbGxUaW1lKTtcclxuICAgICAgICBpZiAobm93IC0gdGhpcy5sYXN0U2Nyb2xsVGltZSA8IHRoaXMuc2Nyb2xsRGVsYXkpIHtcclxuICAgICAgICAgIC8vIFJldHVybmluZyBmYWxzZSBzdG9wcyB0aGUgYnJvd3NlciBmcm9tIHNjcm9sbGluZyBpdHNlbGYuXHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmxhc3RTY3JvbGxUaW1lID0gbm93O1xyXG4gICAgICAgIGlmIChldmVudC5zY3JvbGwgPCAwKSB7XHJcbiAgICAgICAgICB0aGlzLmdvVG9OZXh0RnJhbWUoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5nb1RvUHJldmlvdXNGcmFtZSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gUmV0dXJuaW5nIGZhbHNlIHN0b3BzIHRoZSBicm93c2VyIGZyb20gc2Nyb2xsaW5nIGl0c2VsZi5cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGV2ZW50ID0+IHtcclxuICAgICAgICBpZiAoZXZlbnQuYWx0S2V5IHx8IGV2ZW50LnNoaWZ0S2V5IHx8IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gJ0Fycm93UmlnaHQnIHx8IGV2ZW50LmtleSA9PT0gJ0Fycm93RG93bicgfHwgZXZlbnQua2V5ID09PSAnICcpIHtcclxuICAgICAgICAgIHRoaXMuZ29Ub05leHRGcmFtZSgpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnQua2V5ID09PSAnQXJyb3dMZWZ0JyB8fCBldmVudC5rZXkgPT09ICdBcnJvd1VwJykge1xyXG4gICAgICAgICAgdGhpcy5nb1RvUHJldmlvdXNGcmFtZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG9wZW5Db21pYyhjb21pYzogQ29taWMpIHtcclxuICAgIG9zZFByb21pc2UudGhlbigoKSA9PiB7XHJcbiAgICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbWljLmJvZHkuYmFja2dyb3VuZENvbG9yO1xyXG5cclxuICAgICAgaWYgKHRoaXMudmlld2VyKSB7XHJcbiAgICAgICAgaWYgKGNvbWljLmJvZHkuZnJhbWVzKSB7XHJcbiAgICAgICAgICB0aGlzLmZyYW1lcyA9IGNvbWljLmJvZHkuZnJhbWVzLm1hcChmcmFtZSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgICAgT3BlblNlYWRyYWdvbiAmJlxyXG4gICAgICAgICAgICAgIG5ldyBPcGVuU2VhZHJhZ29uLlJlY3QoXHJcbiAgICAgICAgICAgICAgICBmcmFtZS54IC0gZnJhbWUud2lkdGggLyAyLFxyXG4gICAgICAgICAgICAgICAgZnJhbWUueSAtIGZyYW1lLmhlaWdodCAvIDIsXHJcbiAgICAgICAgICAgICAgICBmcmFtZS53aWR0aCxcclxuICAgICAgICAgICAgICAgIGZyYW1lLmhlaWdodFxyXG4gICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLmZyYW1lcyA9IGNvbWljLmJvZHkuaXRlbXMubWFwKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICAgIE9wZW5TZWFkcmFnb24gJiZcclxuICAgICAgICAgICAgICBuZXcgT3BlblNlYWRyYWdvbi5SZWN0KFxyXG4gICAgICAgICAgICAgICAgaXRlbS54IC0gaXRlbS53aWR0aCAvIDIsXHJcbiAgICAgICAgICAgICAgICBpdGVtLnkgLSBpdGVtLmhlaWdodCAvIDIsXHJcbiAgICAgICAgICAgICAgICBpdGVtLndpZHRoLFxyXG4gICAgICAgICAgICAgICAgaXRlbS5oZWlnaHRcclxuICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbWljLmJvZHkuaXRlbXMuZm9yRWFjaCgoaXRlbSwgaSkgPT4ge1xyXG4gICAgICAgICAgdmFyIHN1Y2Nlc3M7XHJcblxyXG4gICAgICAgICAgaWYgKGkgPT09IDApIHtcclxuICAgICAgICAgICAgc3VjY2VzcyA9ICgpID0+IHRoaXMuZ29Ub0ZyYW1lKDApO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIHRoaXMudmlld2VyPy5hZGRUaWxlZEltYWdlKHtcclxuICAgICAgICAgICAgeDogaXRlbS54IC0gaXRlbS53aWR0aCAvIDIsXHJcbiAgICAgICAgICAgIHk6IGl0ZW0ueSAtIGl0ZW0uaGVpZ2h0IC8gMixcclxuICAgICAgICAgICAgd2lkdGg6IGl0ZW0ud2lkdGgsXHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHN1Y2Nlc3MsXHJcbiAgICAgICAgICAgIHRpbGVTb3VyY2U6IHtcclxuICAgICAgICAgICAgICB0eXBlOiAnbGVnYWN5LWltYWdlLXB5cmFtaWQnLFxyXG4gICAgICAgICAgICAgIGxldmVsczogW1xyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICB1cmw6IGl0ZW0udXJsLFxyXG4gICAgICAgICAgICAgICAgICB3aWR0aDogaXRlbS53aWR0aCxcclxuICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBpdGVtLmhlaWdodFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLm9uQ29taWNMb2FkKSB7XHJcbiAgICAgICAgICB0aGlzLm9uQ29taWNMb2FkKHt9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ29Ub0ZyYW1lKGluZGV4OiBudW1iZXIpIHtcclxuICAgIHZhciBmcmFtZSA9IHRoaXMuZnJhbWVzW2luZGV4XTtcclxuICAgIHZhciBidWZmZXJGYWN0b3IgPSAwLjI7XHJcbiAgICB2YXIgYm94ID0gZnJhbWUuY2xvbmUoKTtcclxuXHJcbiAgICBib3gud2lkdGggKj0gMSArIGJ1ZmZlckZhY3RvcjtcclxuICAgIGJveC5oZWlnaHQgKj0gMSArIGJ1ZmZlckZhY3RvcjtcclxuICAgIGJveC54IC09IGZyYW1lLndpZHRoICogYnVmZmVyRmFjdG9yICogMC41O1xyXG4gICAgYm94LnkgLT0gZnJhbWUuaGVpZ2h0ICogYnVmZmVyRmFjdG9yICogMC41O1xyXG5cclxuICAgIHRoaXMudmlld2VyPy52aWV3cG9ydC5maXRCb3VuZHMoYm94KTtcclxuICB9XHJcblxyXG4gIGdldEZyYW1lSW5kZXgoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUluZGV4O1xyXG4gIH1cclxuXHJcbiAgZmlndXJlRnJhbWVJbmRleCgpIHtcclxuICAgIGxldCBiZXN0SW5kZXggPSAtMTtcclxuICAgIGxldCBiZXN0RGlzdGFuY2UgPSBJbmZpbml0eTtcclxuICAgIGlmICh0aGlzLnZpZXdlcikge1xyXG4gICAgICBjb25zdCB2aWV3cG9ydEJvdW5kcyA9IHRoaXMudmlld2VyLnZpZXdwb3J0LmdldEJvdW5kcyh0cnVlKTtcclxuICAgICAgY29uc3Qgdmlld3BvcnRDZW50ZXIgPSB2aWV3cG9ydEJvdW5kcy5nZXRDZW50ZXIoKTtcclxuXHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5mcmFtZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBjb25zdCBmcmFtZSA9IHRoaXMuZnJhbWVzW2ldO1xyXG4gICAgICAgIGlmIChmcmFtZS5jb250YWluc1BvaW50KHZpZXdwb3J0Q2VudGVyKSkge1xyXG4gICAgICAgICAgY29uc3QgZGlzdGFuY2UgPSB2aWV3cG9ydENlbnRlci5zcXVhcmVkRGlzdGFuY2VUbyhmcmFtZS5nZXRDZW50ZXIoKSk7XHJcbiAgICAgICAgICBpZiAoZGlzdGFuY2UgPCBiZXN0RGlzdGFuY2UpIHtcclxuICAgICAgICAgICAgYmVzdERpc3RhbmNlID0gZGlzdGFuY2U7XHJcbiAgICAgICAgICAgIGJlc3RJbmRleCA9IGk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gYmVzdEluZGV4O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0RnJhbWVDb3VudCgpIHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lcy5sZW5ndGg7XHJcbiAgfVxyXG5cclxuICBnb1RvTmV4dEZyYW1lKCkge1xyXG4gICAgbGV0IGluZGV4ID0gdGhpcy5nZXRGcmFtZUluZGV4KCk7XHJcbiAgICBpZiAoaW5kZXggIT09IHVuZGVmaW5lZCAmJiBpbmRleCA8IHRoaXMuZnJhbWVzLmxlbmd0aCAtIDEpIHtcclxuICAgICAgdGhpcy5nb1RvRnJhbWUoaW5kZXggKyAxKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdvVG9QcmV2aW91c0ZyYW1lKCkge1xyXG4gICAgbGV0IGluZGV4ID0gdGhpcy5nZXRGcmFtZUluZGV4KCk7XHJcbiAgICBpZiAoaW5kZXggIT09IHVuZGVmaW5lZCAmJiBpbmRleCA+IDApIHtcclxuICAgICAgdGhpcy5nb1RvRnJhbWUoaW5kZXggLSAxKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19"}