{"version":3,"sources":["node_modules/browser-pack/_prelude.js","node_modules/@dan503/load-js/index.js","src/demo/demo.ts","src/library/driftory.ts"],"names":[],"mappings":"AAAA;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;AC9BA,iEAA2C;AAE3C,QAAQ,CAAC,gBAAgB,CAAC,kBAAkB,EAAE;IAC5C,IAAM,UAAU,GAAG,QAAQ,CAAC,aAAa,CAAC,cAAc,CAAC,CAAC;IAC1D,IAAM,cAAc,GAAG,QAAQ,CAAC,aAAa,CAAC,kBAAkB,CAAC,CAAC;IAClE,IAAM,SAAS,GAAG,QAAQ,CAAC,aAAa,CAAC,aAAa,CAAC,CAAC;IAExD,IAAM,QAAQ,GAAG,IAAI,kBAAQ,CAAC;QAC5B,SAAS,EAAE,QAAQ,CAAC,aAAa,CAAC,4BAA4B,CAAC;QAC/D,SAAS,EAAE,4EAA4E;QACvF,WAAW,EAAE;YACX,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QACzB,CAAC;QACD,aAAa,EAAE,UAAC,EAA+B;gBAA7B,kBAAc,EAAd,UAAU,mBAAG,CAAC,KAAA,EAAE,WAAW,iBAAA;YAC3C,IAAI,SAAS,EAAE;gBACb,IAAI,IAAI,GAAG,YAAS,UAAU,GAAG,CAAC,CAAE,CAAC;gBACrC,IAAI,WAAW,EAAE;oBACf,IAAI,IAAI,gBAAgB,CAAC;iBAC1B;gBAED,SAAS,CAAC,WAAW,GAAG,IAAI,CAAC;aAC9B;QACH,CAAC;KACF,CAAC,CAAC;IAEH,UAAU,aAAV,UAAU,uBAAV,UAAU,CAAE,gBAAgB,CAAC,OAAO,EAAE;QACpC,QAAQ,CAAC,aAAa,EAAE,CAAC;IAC3B,CAAC,EAAE;IAEH,cAAc,aAAd,cAAc,uBAAd,cAAc,CAAE,gBAAgB,CAAC,OAAO,EAAE;QACxC,QAAQ,CAAC,iBAAiB,EAAE,CAAC;IAC/B,CAAC,EAAE;IAEH,KAAK,CAAC,YAAY,CAAC;SAChB,IAAI,CAAC,UAAA,QAAQ;QACZ,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE;YAChB,OAAO,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;YACxB,MAAM,IAAI,KAAK,CAAC,2BAA2B,CAAC,CAAC;SAC9C;QAED,OAAO,QAAQ,CAAC,IAAI,EAAE,CAAC;IACzB,CAAC,CAAC;SACD,IAAI,CAAC,UAAA,IAAI;QACR,qBAAqB;QACrB,QAAQ,CAAC,SAAS,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;IACjC,CAAC,CAAC;SACD,KAAK,CAAC,UAAA,KAAK,IAAI,OAAA,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,EAApB,CAAoB,CAAC,CAAC;AAC1C,CAAC,CAAC,CAAC;;;;;;;;AC/CH,4DAAqC;AASrC,IAAI,aAA4C,CAAC;AACjD,IAAI,UAAkC,CAAC;AAQvC,IAAM,UAAU,GAAG,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM;IAC7C,UAAU,GAAG,EAAE,OAAO,SAAA,EAAE,MAAM,QAAA,EAAE,CAAC;AACnC,CAAC,CAAC,CAAC;AAcH;IAUE,kBAAY,IAAuB;QAAnC,iBAeC;QArBD,WAAM,GAAiB,EAAE,CAAC;QAC1B,eAAU,GAAY,CAAC,CAAC,CAAC;QACzB,mBAAc,GAAW,CAAC,CAAC;QAC3B,gBAAW,GAAW,IAAI,CAAC;QAIzB,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC;QAChC,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,aAAa,CAAC;QACxC,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,WAAW,CAAC;QAEpC,8FAA8F;QAC9F,mCAAmC;QACnC,iBAAM,CACJ,yFAAyF,EACzF;YACE,aAAa,GAAG,MAAM,CAAC,aAAa,CAAC;YACrC,KAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;YACtB,UAAU,aAAV,UAAU,uBAAV,UAAU,CAAE,OAAO,GAAG;QACxB,CAAC,CACF,CAAC;IACJ,CAAC;IAED,6BAAU,GAAV,UAAW,EAA2C;QAAtD,iBAuGC;YAvGY,SAAS,eAAA,EAAE,SAAS,eAAA;QAC/B,IAAI,CAAC,MAAM;YACT,aAAa;gBACb,aAAa,CAAC;oBACZ,OAAO,EAAE,SAAS;oBAClB,SAAS,EAAE,SAAS;oBACpB,qBAAqB,EAAE,KAAK;oBAC5B,iBAAiB,EAAE,EAAE;oBACrB,oBAAoB,EAAE;wBACpB,WAAW,EAAE,KAAK;qBACnB;iBACF,CAAC,CAAC;QAEL,IAAI,IAAI,CAAC,MAAM,EAAE;YACf,iDAAiD;YACjD,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,WAAW,EAAE;gBAClC,IAAM,UAAU,GAAG,KAAI,CAAC,gBAAgB,EAAE,CAAC;gBAC3C,IAAI,UAAU,KAAK,CAAC,CAAC,IAAI,UAAU,KAAK,KAAI,CAAC,UAAU,EAAE;oBACvD,KAAI,CAAC,UAAU,GAAG,UAAU,CAAC;oBAC7B,IAAI,KAAI,CAAC,aAAa,EAAE;wBACtB,KAAI,CAAC,aAAa,CAAC;4BACjB,UAAU,YAAA;4BACV,WAAW,EAAE,UAAU,KAAK,KAAI,CAAC,aAAa,EAAE,GAAG,CAAC;yBACrD,CAAC,CAAC;qBACJ;iBACF;YACH,CAAC,CAAC,CAAC;YAEH,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,cAAc,EAAE,UAAA,KAAK;gBAC1C,IAAI,CAAC,KAAK,IAAI,CAAC,KAAK,CAAC,KAAK,IAAI,CAAC,KAAK,CAAC,QAAQ,IAAI,CAAC,KAAI,CAAC,MAAM,EAAE;oBAC7D,OAAO;iBACR;gBAED,IAAM,KAAK,GAAG,KAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,cAAc,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;gBAClE,IAAI,UAAU,GAAG,CAAC,CAAC,CAAC;gBACpB,IAAM,SAAS,GAAG,KAAI,CAAC,MAAM,CAAC,KAAK,CAAC,YAAY,EAAE,CAAC;gBAEnD,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,EAAE,CAAC,EAAE,EAAE;oBAClC,IAAM,IAAI,GAAG,KAAI,CAAC,MAAM,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;oBAC5C,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC,aAAa,CAAC,KAAK,CAAC,EAAE;wBACzC,UAAU,GAAG,CAAC,CAAC;qBAChB;iBACF;gBAED,IAAI,UAAU,KAAK,CAAC,CAAC,EAAE;oBACrB,IAAM,cAAc,GAAG,KAAI,CAAC,gBAAgB,EAAE,CAAC;oBAC/C,IAAI,cAAc,KAAK,CAAC,CAAC,IAAI,KAAI,CAAC,UAAU,KAAK,SAAS,EAAE;wBAC1D,KAAI,CAAC,SAAS,CAAC,KAAI,CAAC,UAAU,CAAC,CAAC;qBACjC;yBAAM;wBACL,KAAI,CAAC,aAAa,EAAE,CAAC;qBACtB;iBACF;qBAAM,IAAI,UAAU,KAAK,KAAI,CAAC,UAAU,EAAE;oBACzC,KAAI,CAAC,aAAa,EAAE,CAAC;iBACtB;qBAAM;oBACL,KAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;iBAC5B;YACH,CAAC,CAAC,CAAC;YAEH,IAAM,uBAAqB,GAAG,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,aAAa,CAAC;YACrE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,aAAa,GAAG,UAAA,KAAK;;gBAC5C,IACE,KAAK,CAAC,aAAa,CAAC,OAAO;oBAC3B,KAAK,CAAC,aAAa,CAAC,MAAM;oBAC1B,KAAK,CAAC,aAAa,CAAC,OAAO,EAC3B;oBACA,OAAO,uBAAqB,CAAC,IAAI,OAAC,KAAI,CAAC,MAAM,0CAAE,YAAY,EAAE,KAAK,CAAC,CAAC;iBACrE;gBAED,IAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;gBACvB,6DAA6D;gBAC7D,IAAI,GAAG,GAAG,KAAI,CAAC,cAAc,GAAG,KAAI,CAAC,WAAW,EAAE;oBAChD,2DAA2D;oBAC3D,OAAO,KAAK,CAAC;iBACd;gBAED,KAAI,CAAC,cAAc,GAAG,GAAG,CAAC;gBAC1B,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE;oBACpB,KAAI,CAAC,aAAa,EAAE,CAAC;iBACtB;qBAAM;oBACL,KAAI,CAAC,iBAAiB,EAAE,CAAC;iBAC1B;gBAED,2DAA2D;gBAC3D,OAAO,KAAK,CAAC;YACf,CAAC,CAAC;YAEF,MAAM,CAAC,gBAAgB,CAAC,SAAS,EAAE,UAAA,KAAK;gBACtC,IAAI,KAAK,CAAC,MAAM,IAAI,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,OAAO,IAAI,KAAK,CAAC,OAAO,EAAE;oBACpE,OAAO;iBACR;gBAED,IAAI,KAAK,CAAC,GAAG,KAAK,YAAY,IAAI,KAAK,CAAC,GAAG,KAAK,WAAW,IAAI,KAAK,CAAC,GAAG,KAAK,GAAG,EAAE;oBAChF,KAAI,CAAC,aAAa,EAAE,CAAC;iBACtB;qBAAM,IAAI,KAAK,CAAC,GAAG,KAAK,WAAW,IAAI,KAAK,CAAC,GAAG,KAAK,SAAS,EAAE;oBAC/D,KAAI,CAAC,iBAAiB,EAAE,CAAC;iBAC1B;qBAAM;oBACL,OAAO;iBACR;gBAED,KAAK,CAAC,cAAc,EAAE,CAAC;gBACvB,KAAK,CAAC,eAAe,EAAE,CAAC;YAC1B,CAAC,CAAC,CAAC;SACJ;IACH,CAAC;IAED,4BAAS,GAAT,UAAU,KAAY;QAAtB,iBA6DC;QA5DC,UAAU,CAAC,IAAI,CAAC;YACd,KAAI,CAAC,SAAS,CAAC,KAAK,CAAC,eAAe,GAAG,KAAK,CAAC,IAAI,CAAC,eAAe,CAAC;YAElE,IAAI,KAAI,CAAC,MAAM,EAAE;gBACf,IAAI,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE;oBACrB,KAAI,CAAC,MAAM,GAAG,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,UAAA,KAAK;wBACvC,OAAO,CACL,aAAa;4BACb,IAAI,aAAa,CAAC,IAAI,CACpB,KAAK,CAAC,CAAC,GAAG,KAAK,CAAC,KAAK,GAAG,CAAC,EACzB,KAAK,CAAC,CAAC,GAAG,KAAK,CAAC,MAAM,GAAG,CAAC,EAC1B,KAAK,CAAC,KAAK,EACX,KAAK,CAAC,MAAM,CACb,CACF,CAAC;oBACJ,CAAC,CAAC,CAAC;iBACJ;qBAAM;oBACL,KAAI,CAAC,MAAM,GAAG,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,UAAA,IAAI;wBACrC,OAAO,CACL,aAAa;4BACb,IAAI,aAAa,CAAC,IAAI,CACpB,IAAI,CAAC,CAAC,GAAG,IAAI,CAAC,KAAK,GAAG,CAAC,EACvB,IAAI,CAAC,CAAC,GAAG,IAAI,CAAC,MAAM,GAAG,CAAC,EACxB,IAAI,CAAC,KAAK,EACV,IAAI,CAAC,MAAM,CACZ,CACF,CAAC;oBACJ,CAAC,CAAC,CAAC;iBACJ;gBAED,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,UAAC,IAAI,EAAE,CAAC;;oBAC/B,IAAI,OAAO,CAAC;oBAEZ,IAAI,CAAC,KAAK,CAAC,EAAE;wBACX,OAAO,GAAG,cAAM,OAAA,KAAI,CAAC,SAAS,CAAC,CAAC,CAAC,EAAjB,CAAiB,CAAC;qBACnC;oBAED,MAAA,KAAI,CAAC,MAAM,0CAAE,aAAa,CAAC;wBACzB,CAAC,EAAE,IAAI,CAAC,CAAC,GAAG,IAAI,CAAC,KAAK,GAAG,CAAC;wBAC1B,CAAC,EAAE,IAAI,CAAC,CAAC,GAAG,IAAI,CAAC,MAAM,GAAG,CAAC;wBAC3B,KAAK,EAAE,IAAI,CAAC,KAAK;wBACjB,OAAO,EAAE,OAAO;wBAChB,UAAU,EAAE;4BACV,IAAI,EAAE,sBAAsB;4BAC5B,MAAM,EAAE;gCACN;oCACE,GAAG,EAAE,IAAI,CAAC,GAAG;oCACb,KAAK,EAAE,IAAI,CAAC,KAAK;oCACjB,MAAM,EAAE,IAAI,CAAC,MAAM;iCACpB;6BACF;yBACF;qBACF,EAAE;gBACL,CAAC,CAAC,CAAC;gBAEH,IAAI,KAAI,CAAC,WAAW,EAAE;oBACpB,KAAI,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC;iBACtB;aACF;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAED,4BAAS,GAAT,UAAU,KAAa;;QACrB,IAAI,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAC/B,IAAI,YAAY,GAAG,GAAG,CAAC;QACvB,IAAI,GAAG,GAAG,KAAK,CAAC,KAAK,EAAE,CAAC;QAExB,GAAG,CAAC,KAAK,IAAI,CAAC,GAAG,YAAY,CAAC;QAC9B,GAAG,CAAC,MAAM,IAAI,CAAC,GAAG,YAAY,CAAC;QAC/B,GAAG,CAAC,CAAC,IAAI,KAAK,CAAC,KAAK,GAAG,YAAY,GAAG,GAAG,CAAC;QAC1C,GAAG,CAAC,CAAC,IAAI,KAAK,CAAC,MAAM,GAAG,YAAY,GAAG,GAAG,CAAC;QAE3C,MAAA,IAAI,CAAC,MAAM,0CAAE,QAAQ,CAAC,SAAS,CAAC,GAAG,EAAE;IACvC,CAAC;IAED,gCAAa,GAAb;QACE,OAAO,IAAI,CAAC,UAAU,CAAC;IACzB,CAAC;IAED,mCAAgB,GAAhB;QACE,IAAI,SAAS,GAAG,CAAC,CAAC,CAAC;QACnB,IAAI,YAAY,GAAG,QAAQ,CAAC;QAC5B,IAAI,IAAI,CAAC,MAAM,EAAE;YACf,IAAM,cAAc,GAAG,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;YAC5D,IAAM,cAAc,GAAG,cAAc,CAAC,SAAS,EAAE,CAAC;YAElD,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;gBAC3C,IAAM,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;gBAC7B,IAAI,KAAK,CAAC,aAAa,CAAC,cAAc,CAAC,EAAE;oBACvC,IAAM,QAAQ,GAAG,cAAc,CAAC,iBAAiB,CAAC,KAAK,CAAC,SAAS,EAAE,CAAC,CAAC;oBACrE,IAAI,QAAQ,GAAG,YAAY,EAAE;wBAC3B,YAAY,GAAG,QAAQ,CAAC;wBACxB,SAAS,GAAG,CAAC,CAAC;qBACf;iBACF;aACF;YAED,OAAO,SAAS,CAAC;SAClB;IACH,CAAC;IAED,gCAAa,GAAb;QACE,OAAO,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC;IAC5B,CAAC;IAED,gCAAa,GAAb;QACE,IAAI,KAAK,GAAG,IAAI,CAAC,aAAa,EAAE,CAAC;QACjC,IAAI,KAAK,KAAK,SAAS,IAAI,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE;YACzD,IAAI,CAAC,SAAS,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC;SAC3B;IACH,CAAC;IAED,oCAAiB,GAAjB;QACE,IAAI,KAAK,GAAG,IAAI,CAAC,aAAa,EAAE,CAAC;QACjC,IAAI,KAAK,KAAK,SAAS,IAAI,KAAK,GAAG,CAAC,EAAE;YACpC,IAAI,CAAC,SAAS,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC;SAC3B;IACH,CAAC;IACH,eAAC;AAAD,CA3PA,AA2PC,IAAA","file":"demo.js","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()","\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar alreadyCalledSources = [];\r\nvar awaitingCallbacks = {};\r\nvar addCallback = function (src, callback) {\r\n    if (awaitingCallbacks[src]) {\r\n        awaitingCallbacks[src].push(callback);\r\n    }\r\n    else {\r\n        awaitingCallbacks[src] = [callback];\r\n    }\r\n};\r\nfunction loadJS(src, callback) {\r\n    if (alreadyCalledSources.indexOf(src) < 0) {\r\n        alreadyCalledSources.push(src);\r\n        var script = document.createElement('script');\r\n        script.src = src;\r\n        script.onload = function () {\r\n            addCallback(src, callback);\r\n            for (var key in awaitingCallbacks) {\r\n                awaitingCallbacks[key].forEach(function (cb) { return cb(); });\r\n            }\r\n        };\r\n        document.head.appendChild(script);\r\n    }\r\n    else {\r\n        addCallback(src, callback);\r\n    }\r\n}\r\nexports.default = loadJS;\r\n","import Driftory from '../library/driftory';\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  const nextButton = document.querySelector('.next-button');\n  const previousButton = document.querySelector('.previous-button');\n  const frameInfo = document.querySelector('.frame-info');\n\n  const driftory = new Driftory({\n    container: document.querySelector('.driftory-viewer-container'),\n    prefixUrl: 'https://cdn.jsdelivr.net/npm/openseadragon@2.4/build/openseadragon/images/',\n    onComicLoad: () => {\n      console.log('loaded!');\n    },\n    onFrameChange: ({ frameIndex = 0, isLastFrame }) => {\n      if (frameInfo) {\n        let text = `Frame ${frameIndex + 1}`;\n        if (isLastFrame) {\n          text += ' (last frame!)';\n        }\n\n        frameInfo.textContent = text;\n      }\n    }\n  });\n\n  nextButton?.addEventListener('click', () => {\n    driftory.goToNextFrame();\n  });\n\n  previousButton?.addEventListener('click', () => {\n    driftory.goToPreviousFrame();\n  });\n\n  fetch('comic.json')\n    .then(response => {\n      if (!response.ok) {\n        console.error(response);\n        throw new Error('Failed to load comic.json');\n      }\n\n      return response.json();\n    })\n    .then(json => {\n      // console.log(json);\n      driftory.openComic(json.comic);\n    })\n    .catch(error => console.error(error));\n});\n","import loadJs from '@dan503/load-js';\nimport { Comic } from '../../Comic.types';\nimport { OpenSeadragonType, ViewerType } from './openseadragon.types';\n\ninterface OsdRequest {\n  resolve: (value?: unknown) => void;\n  reject: (reason?: any) => void;\n}\n\nlet OpenSeadragon: OpenSeadragonType | undefined;\nlet osdRequest: OsdRequest | undefined;\n\ndeclare global {\n  interface Window {\n    OpenSeadragon: OpenSeadragonType;\n  }\n}\n\nconst osdPromise = new Promise((resolve, reject) => {\n  osdRequest = { resolve, reject };\n});\n\ntype Frame = any;\ntype Container = any;\ntype OnFrameChange = (params: { frameIndex?: number; isLastFrame: boolean }) => void;\ntype OnComicLoad = (params: {}) => void;\n\ninterface DriftoryArguments {\n  container: any;\n  onFrameChange: OnFrameChange;\n  onComicLoad: OnComicLoad;\n  prefixUrl: string;\n}\n\nexport default class Driftory {\n  container: Container;\n  onFrameChange: OnFrameChange;\n  onComicLoad: OnComicLoad;\n  frames: Array<Frame> = [];\n  frameIndex?: number = -1;\n  lastScrollTime: number = 0;\n  scrollDelay: number = 2000;\n  viewer?: ViewerType;\n\n  constructor(args: DriftoryArguments) {\n    this.container = args.container;\n    this.onFrameChange = args.onFrameChange;\n    this.onComicLoad = args.onComicLoad;\n\n    // Note: loadJs only loads the file once, even if called multiple times, and always makes sure\n    // all of the callbacks are called.\n    loadJs(\n      'https://cdn.jsdelivr.net/npm/openseadragon@2.4/build/openseadragon/openseadragon.min.js',\n      () => {\n        OpenSeadragon = window.OpenSeadragon;\n        this.initialize(args);\n        osdRequest?.resolve();\n      }\n    );\n  }\n\n  initialize({ container, prefixUrl }: DriftoryArguments) {\n    this.viewer =\n      OpenSeadragon &&\n      OpenSeadragon({\n        element: container,\n        prefixUrl: prefixUrl,\n        showNavigationControl: false,\n        maxZoomPixelRatio: 10,\n        gestureSettingsMouse: {\n          clickToZoom: false\n        }\n      });\n\n    if (this.viewer) {\n      // TODO: Maybe don't need to do this every frame.\n      this.viewer.addHandler('animation', () => {\n        const frameIndex = this.figureFrameIndex();\n        if (frameIndex !== -1 && frameIndex !== this.frameIndex) {\n          this.frameIndex = frameIndex;\n          if (this.onFrameChange) {\n            this.onFrameChange({\n              frameIndex,\n              isLastFrame: frameIndex === this.getFrameCount() - 1\n            });\n          }\n        }\n      });\n\n      this.viewer.addHandler('canvas-click', event => {\n        if (!event || !event.quick || !event.position || !this.viewer) {\n          return;\n        }\n\n        const point = this.viewer.viewport.pointFromPixel(event.position);\n        let foundIndex = -1;\n        const itemCount = this.viewer.world.getItemCount();\n\n        for (let i = 0; i < itemCount; i++) {\n          const item = this.viewer.world.getItemAt(i);\n          if (item.getBounds().containsPoint(point)) {\n            foundIndex = i;\n          }\n        }\n\n        if (foundIndex === -1) {\n          const realFrameIndex = this.figureFrameIndex();\n          if (realFrameIndex === -1 && this.frameIndex !== undefined) {\n            this.goToFrame(this.frameIndex);\n          } else {\n            this.goToNextFrame();\n          }\n        } else if (foundIndex === this.frameIndex) {\n          this.goToNextFrame();\n        } else {\n          this.goToFrame(foundIndex);\n        }\n      });\n\n      const originalScrollHandler = this.viewer.innerTracker.scrollHandler;\n      this.viewer.innerTracker.scrollHandler = event => {\n        if (\n          event.originalEvent.ctrlKey ||\n          event.originalEvent.altKey ||\n          event.originalEvent.metaKey\n        ) {\n          return originalScrollHandler.call(this.viewer?.innerTracker, event);\n        }\n\n        const now = Date.now();\n        // console.log(event.scroll, now, now - this.lastScrollTime);\n        if (now - this.lastScrollTime < this.scrollDelay) {\n          // Returning false stops the browser from scrolling itself.\n          return false;\n        }\n\n        this.lastScrollTime = now;\n        if (event.scroll < 0) {\n          this.goToNextFrame();\n        } else {\n          this.goToPreviousFrame();\n        }\n\n        // Returning false stops the browser from scrolling itself.\n        return false;\n      };\n\n      window.addEventListener('keydown', event => {\n        if (event.altKey || event.shiftKey || event.ctrlKey || event.metaKey) {\n          return;\n        }\n\n        if (event.key === 'ArrowRight' || event.key === 'ArrowDown' || event.key === ' ') {\n          this.goToNextFrame();\n        } else if (event.key === 'ArrowLeft' || event.key === 'ArrowUp') {\n          this.goToPreviousFrame();\n        } else {\n          return;\n        }\n\n        event.preventDefault();\n        event.stopPropagation();\n      });\n    }\n  }\n\n  openComic(comic: Comic) {\n    osdPromise.then(() => {\n      this.container.style.backgroundColor = comic.body.backgroundColor;\n\n      if (this.viewer) {\n        if (comic.body.frames) {\n          this.frames = comic.body.frames.map(frame => {\n            return (\n              OpenSeadragon &&\n              new OpenSeadragon.Rect(\n                frame.x - frame.width / 2,\n                frame.y - frame.height / 2,\n                frame.width,\n                frame.height\n              )\n            );\n          });\n        } else {\n          this.frames = comic.body.items.map(item => {\n            return (\n              OpenSeadragon &&\n              new OpenSeadragon.Rect(\n                item.x - item.width / 2,\n                item.y - item.height / 2,\n                item.width,\n                item.height\n              )\n            );\n          });\n        }\n\n        comic.body.items.forEach((item, i) => {\n          var success;\n\n          if (i === 0) {\n            success = () => this.goToFrame(0);\n          }\n\n          this.viewer?.addTiledImage({\n            x: item.x - item.width / 2,\n            y: item.y - item.height / 2,\n            width: item.width,\n            success: success,\n            tileSource: {\n              type: 'legacy-image-pyramid',\n              levels: [\n                {\n                  url: item.url,\n                  width: item.width,\n                  height: item.height\n                }\n              ]\n            }\n          });\n        });\n\n        if (this.onComicLoad) {\n          this.onComicLoad({});\n        }\n      }\n    });\n  }\n\n  goToFrame(index: number) {\n    var frame = this.frames[index];\n    var bufferFactor = 0.2;\n    var box = frame.clone();\n\n    box.width *= 1 + bufferFactor;\n    box.height *= 1 + bufferFactor;\n    box.x -= frame.width * bufferFactor * 0.5;\n    box.y -= frame.height * bufferFactor * 0.5;\n\n    this.viewer?.viewport.fitBounds(box);\n  }\n\n  getFrameIndex() {\n    return this.frameIndex;\n  }\n\n  figureFrameIndex() {\n    let bestIndex = -1;\n    let bestDistance = Infinity;\n    if (this.viewer) {\n      const viewportBounds = this.viewer.viewport.getBounds(true);\n      const viewportCenter = viewportBounds.getCenter();\n\n      for (let i = 0; i < this.frames.length; i++) {\n        const frame = this.frames[i];\n        if (frame.containsPoint(viewportCenter)) {\n          const distance = viewportCenter.squaredDistanceTo(frame.getCenter());\n          if (distance < bestDistance) {\n            bestDistance = distance;\n            bestIndex = i;\n          }\n        }\n      }\n\n      return bestIndex;\n    }\n  }\n\n  getFrameCount() {\n    return this.frames.length;\n  }\n\n  goToNextFrame() {\n    let index = this.getFrameIndex();\n    if (index !== undefined && index < this.frames.length - 1) {\n      this.goToFrame(index + 1);\n    }\n  }\n\n  goToPreviousFrame() {\n    let index = this.getFrameIndex();\n    if (index !== undefined && index > 0) {\n      this.goToFrame(index - 1);\n    }\n  }\n}\n"],"preExistingComment":"//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJub2RlX21vZHVsZXMvQGRhbjUwMy9sb2FkLWpzL2luZGV4LmpzIiwic3JjL2RlbW8vZGVtby50cyIsInNyYy9saWJyYXJ5L2RyaWZ0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FDQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7Ozs7Ozs7QUM5QkEsaUVBQTJDO0FBRTNDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxrQkFBa0IsRUFBRTtJQUM1QyxJQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQzFELElBQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUNsRSxJQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBRXhELElBQU0sUUFBUSxHQUFHLElBQUksa0JBQVEsQ0FBQztRQUM1QixTQUFTLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyw0QkFBNEIsQ0FBQztRQUMvRCxTQUFTLEVBQUUsNEVBQTRFO1FBQ3ZGLFdBQVcsRUFBRTtZQUNYLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDekIsQ0FBQztRQUNELGFBQWEsRUFBRSxVQUFDLEVBQStCO2dCQUE3QixrQkFBYyxFQUFkLFVBQVUsbUJBQUcsQ0FBQyxLQUFBLEVBQUUsV0FBVyxpQkFBQTtZQUMzQyxJQUFJLFNBQVMsRUFBRTtnQkFDYixJQUFJLElBQUksR0FBRyxZQUFTLFVBQVUsR0FBRyxDQUFDLENBQUUsQ0FBQztnQkFDckMsSUFB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QixDQUFDO0lBRUQsZ0NBQWEsR0FBYjtRQUNFLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNqQyxJQUFJLEtBQUssS0FBSyxTQUFTLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN6RCxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztTQUMzQjtJQUNILENBQUM7SUFFRCxvQ0FBaUIsR0FBakI7UUFDRSxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDakMsSUFBSSxLQUFLLEtBQUssU0FBUyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUU7WUFDcEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDM0I7SUFDSCxDQUFDO0lBQ0gsZUFBQztBQUFELENBM1BBLEFBMlBDLElBQUEiLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbigpe2Z1bmN0aW9uIHIoZSxuLHQpe2Z1bmN0aW9uIG8oaSxmKXtpZighbltpXSl7aWYoIWVbaV0pe3ZhciBjPVwiZnVuY3Rpb25cIj09dHlwZW9mIHJlcXVpcmUmJnJlcXVpcmU7aWYoIWYmJmMpcmV0dXJuIGMoaSwhMCk7aWYodSlyZXR1cm4gdShpLCEwKTt2YXIgYT1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK2krXCInXCIpO3Rocm93IGEuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixhfXZhciBwPW5baV09e2V4cG9ydHM6e319O2VbaV1bMF0uY2FsbChwLmV4cG9ydHMsZnVuY3Rpb24ocil7dmFyIG49ZVtpXVsxXVtyXTtyZXR1cm4gbyhufHxyKX0scCxwLmV4cG9ydHMscixlLG4sdCl9cmV0dXJuIG5baV0uZXhwb3J0c31mb3IodmFyIHU9XCJmdW5jdGlvblwiPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZSxpPTA7aTx0Lmxlbmd0aDtpKyspbyh0W2ldKTtyZXR1cm4gb31yZXR1cm4gcn0pKCkiLCJcInVzZSBzdHJpY3RcIjtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG52YXIgYWxyZWFkeUNhbGxlZFNvdXJjZXMgPSBbXTtcclxudmFyIGF3YWl0aW5nQ2FsbGJhY2tzID0ge307XHJcbnZhciBhZGRDYWxsYmFjayA9IGZ1bmN0aW9uIChzcmMsIGNhbGxiYWNrKSB7XHJcbiAgICBpZiAoYXdhaXRpbmdDYWxsYmFja3Nbc3JjXSkge1xyXG4gICAgICAgIGF3YWl0aW5nQ2FsbGJhY2tzW3NyY10ucHVzaChjYWxsYmFjayk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBhd2FpdGluZ0NhbGxiYWNrc1tzcmNdID0gW2NhbGxiYWNrXTtcclxuICAgIH1cclxufTtcclxuZnVuY3Rpb24gbG9hZEpTKHNyYywgY2FsbGJhY2spIHtcclxuICAgIGlmIChhbHJlYWR5Q2FsbGVkU291cmNlcy5pbmRleE9mKHNyYykgPCAwKSB7XHJcbiAgICAgICAgYWxyZWFkeUNhbGxlZFNvdXJjZXMucHVzaChzcmMpO1xyXG4gICAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcclxuICAgICAgICBzY3JpcHQuc3JjID0gc3JjO1xyXG4gICAgICAgIHNjcmlwdC5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGFkZENhbGxiYWNrKHNyYywgY2FsbGJhY2spO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gYXdhaXRpbmdDYWxsYmFja3MpIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0aW5nQ2FsbGJhY2tzW2tleV0uZm9yRWFjaChmdW5jdGlvbiAoY2IpIHsgcmV0dXJuIGNiKCk7IH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBhZGRDYWxsYmFjayhzcmMsIGNhbGxiYWNrKTtcclxuICAgIH1cclxufVxyXG5leHBvcnRzLmRlZmF1bHQgPSBsb2FkSlM7XHJcbiIsImltcG9ydCBEcmlmdG9yeSBmcm9tICcuLi9saWJyYXJ5L2RyaWZ0b3J5JztcblxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsICgpID0+IHtcbiAgY29uc3QgbmV4dEJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5uZXh0LWJ1dHRvbicpO1xuICBjb25zdCBwcmV2aW91c0J1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5wcmV2aW91cy1idXR0b24nKTtcbiAgY29uc3QgZnJhbWVJbmZvID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmZyYW1lLWluZm8nKTtcblxuICBjb25zdCBkcmlmdG9yeSA9IG5ldyBEcmlmdG9yeSh7XG4gICAgY29udGFpbmVyOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZHJpZnRvcnktdmlld2VyLWNvbnRhaW5lcicpLFxuICAgIHByZWZpeFVybDogJ2h0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vb3BlbnNlYWRyYWdvbkAyLjQvYnVpbGQvb3BlbnNlYWRyYWdvbi9pbWFnZXMvJyxcbiAgICBvbkNvbWljTG9hZDogKCkgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ2xvYWRlZCEnKTtcbiAgICB9LFxuICAgIG9uRnJhbWVDaGFuZ2U6ICh7IGZyYW1lSW5kZXggPSAwLCBpc0xhc3RGcmFtZSB9KSA9PiB7XG4gICAgICBpZiAoZnJhbWVJbmZvKSB7XG4gICAgICAgIGxldCB0ZXh0ID0gYEZyYW1lICR7ZnJhbWVJbmRleCArIDF9YDtcbiAgICAgICAgaWYgKGlzTGFzdEZyYW1lKSB7XG4gICAgICAgICAgdGV4dCArPSAnIChsYXN0IGZyYW1lISknO1xuICAgICAgICB9XG5cbiAgICAgICAgZnJhbWVJbmZvLnRleHRDb250ZW50ID0gdGV4dDtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIG5leHRCdXR0b24/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgIGRyaWZ0b3J5LmdvVG9OZXh0RnJhbWUoKTtcbiAgfSk7XG5cbiAgcHJldmlvdXNCdXR0b24/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgIGRyaWZ0b3J5LmdvVG9QcmV2aW91c0ZyYW1lKCk7XG4gIH0pO1xuXG4gIGZldGNoKCdjb21pYy5qc29uJylcbiAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IocmVzcG9uc2UpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBsb2FkIGNvbWljLmpzb24nKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICB9KVxuICAgIC50aGVuKGpzb24gPT4ge1xuICAgICAgLy8gY29uc29sZS5sb2coanNvbik7XG4gICAgICBkcmlmdG9yeS5vcGVuQ29taWMoanNvbi5jb21pYyk7XG4gICAgfSlcbiAgICAuY2F0Y2goZXJyb3IgPT4gY29uc29sZS5lcnJvcihlcnJvcikpO1xufSk7XG4iLCJpbXBvcnQgbG9hZEpzIGZyb20gJ0BkYW41MDMvbG9hZC1qcyc7XG5pbXBvcnQgeyBDb21pYyB9IGZyb20gJy4uLy4uL0NvbWljLnR5cGVzJztcbmltcG9ydCB7IE9wZW5TZWFkcmFnb25UeXBlLCBWaWV3ZXJUeXBlIH0gZnJvbSAnLi9vcGVuc2VhZHJhZ29uLnR5cGVzJztcblxuaW50ZXJmYWNlIE9zZFJlcXVlc3Qge1xuICByZXNvbHZlOiAodmFsdWU/OiB1bmtub3duKSA9PiB2b2lkO1xuICByZWplY3Q6IChyZWFzb24/OiBhbnkpID0+IHZvaWQ7XG59XG5cbmxldCBPcGVuU2VhZHJhZ29uOiBPcGVuU2VhZHJhZ29uVHlwZSB8IHVuZGVmaW5lZDtcbmxldCBvc2RSZXF1ZXN0OiBPc2RSZXF1ZXN0IHwgdW5kZWZpbmVkO1xuXG5kZWNsYXJlIGdsb2JhbCB7XG4gIGludGVyZmFjZSBXaW5kb3cge1xuICAgIE9wZW5TZWFkcmFnb246IE9wZW5TZWFkcmFnb25UeXBlO1xuICB9XG59XG5cbmNvbnN0IG9zZFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gIG9zZFJlcXVlc3QgPSB7IHJlc29sdmUsIHJlamVjdCB9O1xufSk7XG5cbnR5cGUgRnJhbWUgPSBhbnk7XG50eXBlIENvbnRhaW5lciA9IGFueTtcbnR5cGUgT25GcmFtZUNoYW5nZSA9IChwYXJhbXM6IHsgZnJhbWVJbmRleD86IG51bWJlcjsgaXNMYXN0RnJhbWU6IGJvb2xlYW4gfSkgPT4gdm9pZDtcbnR5cGUgT25Db21pY0xvYWQgPSAocGFyYW1zOiB7fSkgPT4gdm9pZDtcblxuaW50ZXJmYWNlIERyaWZ0b3J5QXJndW1lbnRzIHtcbiAgY29udGFpbmVyOiBhbnk7XG4gIG9uRnJhbWVDaGFuZ2U6IE9uRnJhbWVDaGFuZ2U7XG4gIG9uQ29taWNMb2FkOiBPbkNvbWljTG9hZDtcbiAgcHJlZml4VXJsOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERyaWZ0b3J5IHtcbiAgY29udGFpbmVyOiBDb250YWluZXI7XG4gIG9uRnJhbWVDaGFuZ2U6IE9uRnJhbWVDaGFuZ2U7XG4gIG9uQ29taWNMb2FkOiBPbkNvbWljTG9hZDtcbiAgZnJhbWVzOiBBcnJheTxGcmFtZT4gPSBbXTtcbiAgZnJhbWVJbmRleD86IG51bWJlciA9IC0xO1xuICBsYXN0U2Nyb2xsVGltZTogbnVtYmVyID0gMDtcbiAgc2Nyb2xsRGVsYXk6IG51bWJlciA9IDIwMDA7XG4gIHZpZXdlcj86IFZpZXdlclR5cGU7XG5cbiAgY29uc3RydWN0b3IoYXJnczogRHJpZnRvcnlBcmd1bWVudHMpIHtcbiAgICB0aGlzLmNvbnRhaW5lciA9IGFyZ3MuY29udGFpbmVyO1xuICAgIHRoaXMub25GcmFtZUNoYW5nZSA9IGFyZ3Mub25GcmFtZUNoYW5nZTtcbiAgICB0aGlzLm9uQ29taWNMb2FkID0gYXJncy5vbkNvbWljTG9hZDtcblxuICAgIC8vIE5vdGU6IGxvYWRKcyBvbmx5IGxvYWRzIHRoZSBmaWxlIG9uY2UsIGV2ZW4gaWYgY2FsbGVkIG11bHRpcGxlIHRpbWVzLCBhbmQgYWx3YXlzIG1ha2VzIHN1cmVcbiAgICAvLyBhbGwgb2YgdGhlIGNhbGxiYWNrcyBhcmUgY2FsbGVkLlxuICAgIGxvYWRKcyhcbiAgICAgICdodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL29wZW5zZWFkcmFnb25AMi40L2J1aWxkL29wZW5zZWFkcmFnb24vb3BlbnNlYWRyYWdvbi5taW4uanMnLFxuICAgICAgKCkgPT4ge1xuICAgICAgICBPcGVuU2VhZHJhZ29uID0gd2luZG93Lk9wZW5TZWFkcmFnb247XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZShhcmdzKTtcbiAgICAgICAgb3NkUmVxdWVzdD8ucmVzb2x2ZSgpO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBpbml0aWFsaXplKHsgY29udGFpbmVyLCBwcmVmaXhVcmwgfTogRHJpZnRvcnlBcmd1bWVudHMpIHtcbiAgICB0aGlzLnZpZXdlciA9XG4gICAgICBPcGVuU2VhZHJhZ29uICYmXG4gICAgICBPcGVuU2VhZHJhZ29uKHtcbiAgICAgICAgZWxlbWVudDogY29udGFpbmVyLFxuICAgICAgICBwcmVmaXhVcmw6IHByZWZpeFVybCxcbiAgICAgICAgc2hvd05hdmlnYXRpb25Db250cm9sOiBmYWxzZSxcbiAgICAgICAgbWF4Wm9vbVBpeGVsUmF0aW86IDEwLFxuICAgICAgICBnZXN0dXJlU2V0dGluZ3NNb3VzZToge1xuICAgICAgICAgIGNsaWNrVG9ab29tOiBmYWxzZVxuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgIGlmICh0aGlzLnZpZXdlcikge1xuICAgICAgLy8gVE9ETzogTWF5YmUgZG9uJ3QgbmVlZCB0byBkbyB0aGlzIGV2ZXJ5IGZyYW1lLlxuICAgICAgdGhpcy52aWV3ZXIuYWRkSGFuZGxlcignYW5pbWF0aW9uJywgKCkgPT4ge1xuICAgICAgICBjb25zdCBmcmFtZUluZGV4ID0gdGhpcy5maWd1cmVGcmFtZUluZGV4KCk7XG4gICAgICAgIGlmIChmcmFtZUluZGV4ICE9PSAtMSAmJiBmcmFtZUluZGV4ICE9PSB0aGlzLmZyYW1lSW5kZXgpIHtcbiAgICAgICAgICB0aGlzLmZyYW1lSW5kZXggPSBmcmFtZUluZGV4O1xuICAgICAgICAgIGlmICh0aGlzLm9uRnJhbWVDaGFuZ2UpIHtcbiAgICAgICAgICAgIHRoaXMub25GcmFtZUNoYW5nZSh7XG4gICAgICAgICAgICAgIGZyYW1lSW5kZXgsXG4gICAgICAgICAgICAgIGlzTGFzdEZyYW1lOiBmcmFtZUluZGV4ID09PSB0aGlzLmdldEZyYW1lQ291bnQoKSAtIDFcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMudmlld2VyLmFkZEhhbmRsZXIoJ2NhbnZhcy1jbGljaycsIGV2ZW50ID0+IHtcbiAgICAgICAgaWYgKCFldmVudCB8fCAhZXZlbnQucXVpY2sgfHwgIWV2ZW50LnBvc2l0aW9uIHx8ICF0aGlzLnZpZXdlcikge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHBvaW50ID0gdGhpcy52aWV3ZXIudmlld3BvcnQucG9pbnRGcm9tUGl4ZWwoZXZlbnQucG9zaXRpb24pO1xuICAgICAgICBsZXQgZm91bmRJbmRleCA9IC0xO1xuICAgICAgICBjb25zdCBpdGVtQ291bnQgPSB0aGlzLnZpZXdlci53b3JsZC5nZXRJdGVtQ291bnQoKTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZW1Db3VudDsgaSsrKSB7XG4gICAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMudmlld2VyLndvcmxkLmdldEl0ZW1BdChpKTtcbiAgICAgICAgICBpZiAoaXRlbS5nZXRCb3VuZHMoKS5jb250YWluc1BvaW50KHBvaW50KSkge1xuICAgICAgICAgICAgZm91bmRJbmRleCA9IGk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZvdW5kSW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgY29uc3QgcmVhbEZyYW1lSW5kZXggPSB0aGlzLmZpZ3VyZUZyYW1lSW5kZXgoKTtcbiAgICAgICAgICBpZiAocmVhbEZyYW1lSW5kZXggPT09IC0xICYmIHRoaXMuZnJhbWVJbmRleCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmdvVG9GcmFtZSh0aGlzLmZyYW1lSW5kZXgpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmdvVG9OZXh0RnJhbWUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoZm91bmRJbmRleCA9PT0gdGhpcy5mcmFtZUluZGV4KSB7XG4gICAgICAgICAgdGhpcy5nb1RvTmV4dEZyYW1lKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5nb1RvRnJhbWUoZm91bmRJbmRleCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBvcmlnaW5hbFNjcm9sbEhhbmRsZXIgPSB0aGlzLnZpZXdlci5pbm5lclRyYWNrZXIuc2Nyb2xsSGFuZGxlcjtcbiAgICAgIHRoaXMudmlld2VyLmlubmVyVHJhY2tlci5zY3JvbGxIYW5kbGVyID0gZXZlbnQgPT4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgZXZlbnQub3JpZ2luYWxFdmVudC5jdHJsS2V5IHx8XG4gICAgICAgICAgZXZlbnQub3JpZ2luYWxFdmVudC5hbHRLZXkgfHxcbiAgICAgICAgICBldmVudC5vcmlnaW5hbEV2ZW50Lm1ldGFLZXlcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmV0dXJuIG9yaWdpbmFsU2Nyb2xsSGFuZGxlci5jYWxsKHRoaXMudmlld2VyPy5pbm5lclRyYWNrZXIsIGV2ZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGV2ZW50LnNjcm9sbCwgbm93LCBub3cgLSB0aGlzLmxhc3RTY3JvbGxUaW1lKTtcbiAgICAgICAgaWYgKG5vdyAtIHRoaXMubGFzdFNjcm9sbFRpbWUgPCB0aGlzLnNjcm9sbERlbGF5KSB7XG4gICAgICAgICAgLy8gUmV0dXJuaW5nIGZhbHNlIHN0b3BzIHRoZSBicm93c2VyIGZyb20gc2Nyb2xsaW5nIGl0c2VsZi5cbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxhc3RTY3JvbGxUaW1lID0gbm93O1xuICAgICAgICBpZiAoZXZlbnQuc2Nyb2xsIDwgMCkge1xuICAgICAgICAgIHRoaXMuZ29Ub05leHRGcmFtZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuZ29Ub1ByZXZpb3VzRnJhbWUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJldHVybmluZyBmYWxzZSBzdG9wcyB0aGUgYnJvd3NlciBmcm9tIHNjcm9sbGluZyBpdHNlbGYuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH07XG5cbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgZXZlbnQgPT4ge1xuICAgICAgICBpZiAoZXZlbnQuYWx0S2V5IHx8IGV2ZW50LnNoaWZ0S2V5IHx8IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChldmVudC5rZXkgPT09ICdBcnJvd1JpZ2h0JyB8fCBldmVudC5rZXkgPT09ICdBcnJvd0Rvd24nIHx8IGV2ZW50LmtleSA9PT0gJyAnKSB7XG4gICAgICAgICAgdGhpcy5nb1RvTmV4dEZyYW1lKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnQua2V5ID09PSAnQXJyb3dMZWZ0JyB8fCBldmVudC5rZXkgPT09ICdBcnJvd1VwJykge1xuICAgICAgICAgIHRoaXMuZ29Ub1ByZXZpb3VzRnJhbWUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIG9wZW5Db21pYyhjb21pYzogQ29taWMpIHtcbiAgICBvc2RQcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgdGhpcy5jb250YWluZXIuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29taWMuYm9keS5iYWNrZ3JvdW5kQ29sb3I7XG5cbiAgICAgIGlmICh0aGlzLnZpZXdlcikge1xuICAgICAgICBpZiAoY29taWMuYm9keS5mcmFtZXMpIHtcbiAgICAgICAgICB0aGlzLmZyYW1lcyA9IGNvbWljLmJvZHkuZnJhbWVzLm1hcChmcmFtZSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICBPcGVuU2VhZHJhZ29uICYmXG4gICAgICAgICAgICAgIG5ldyBPcGVuU2VhZHJhZ29uLlJlY3QoXG4gICAgICAgICAgICAgICAgZnJhbWUueCAtIGZyYW1lLndpZHRoIC8gMixcbiAgICAgICAgICAgICAgICBmcmFtZS55IC0gZnJhbWUuaGVpZ2h0IC8gMixcbiAgICAgICAgICAgICAgICBmcmFtZS53aWR0aCxcbiAgICAgICAgICAgICAgICBmcmFtZS5oZWlnaHRcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmZyYW1lcyA9IGNvbWljLmJvZHkuaXRlbXMubWFwKGl0ZW0gPT4ge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgT3BlblNlYWRyYWdvbiAmJlxuICAgICAgICAgICAgICBuZXcgT3BlblNlYWRyYWdvbi5SZWN0KFxuICAgICAgICAgICAgICAgIGl0ZW0ueCAtIGl0ZW0ud2lkdGggLyAyLFxuICAgICAgICAgICAgICAgIGl0ZW0ueSAtIGl0ZW0uaGVpZ2h0IC8gMixcbiAgICAgICAgICAgICAgICBpdGVtLndpZHRoLFxuICAgICAgICAgICAgICAgIGl0ZW0uaGVpZ2h0XG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb21pYy5ib2R5Lml0ZW1zLmZvckVhY2goKGl0ZW0sIGkpID0+IHtcbiAgICAgICAgICB2YXIgc3VjY2VzcztcblxuICAgICAgICAgIGlmIChpID09PSAwKSB7XG4gICAgICAgICAgICBzdWNjZXNzID0gKCkgPT4gdGhpcy5nb1RvRnJhbWUoMCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdGhpcy52aWV3ZXI/LmFkZFRpbGVkSW1hZ2Uoe1xuICAgICAgICAgICAgeDogaXRlbS54IC0gaXRlbS53aWR0aCAvIDIsXG4gICAgICAgICAgICB5OiBpdGVtLnkgLSBpdGVtLmhlaWdodCAvIDIsXG4gICAgICAgICAgICB3aWR0aDogaXRlbS53aWR0aCxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHN1Y2Nlc3MsXG4gICAgICAgICAgICB0aWxlU291cmNlOiB7XG4gICAgICAgICAgICAgIHR5cGU6ICdsZWdhY3ktaW1hZ2UtcHlyYW1pZCcsXG4gICAgICAgICAgICAgIGxldmVsczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHVybDogaXRlbS51cmwsXG4gICAgICAgICAgICAgICAgICB3aWR0aDogaXRlbS53aWR0aCxcbiAgICAgICAgICAgICAgICAgIGhlaWdodDogaXRlbS5oZWlnaHRcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIF1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHRoaXMub25Db21pY0xvYWQpIHtcbiAgICAgICAgICB0aGlzLm9uQ29taWNMb2FkKHt9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZ29Ub0ZyYW1lKGluZGV4OiBudW1iZXIpIHtcbiAgICB2YXIgZnJhbWUgPSB0aGlzLmZyYW1lc1tpbmRleF07XG4gICAgdmFyIGJ1ZmZlckZhY3RvciA9IDAuMjtcbiAgICB2YXIgYm94ID0gZnJhbWUuY2xvbmUoKTtcblxuICAgIGJveC53aWR0aCAqPSAxICsgYnVmZmVyRmFjdG9yO1xuICAgIGJveC5oZWlnaHQgKj0gMSArIGJ1ZmZlckZhY3RvcjtcbiAgICBib3gueCAtPSBmcmFtZS53aWR0aCAqIGJ1ZmZlckZhY3RvciAqIDAuNTtcbiAgICBib3gueSAtPSBmcmFtZS5oZWlnaHQgKiBidWZmZXJGYWN0b3IgKiAwLjU7XG5cbiAgICB0aGlzLnZpZXdlcj8udmlld3BvcnQuZml0Qm91bmRzKGJveCk7XG4gIH1cblxuICBnZXRGcmFtZUluZGV4KCkge1xuICAgIHJldHVybiB0aGlzLmZyYW1lSW5kZXg7XG4gIH1cblxuICBmaWd1cmVGcmFtZUluZGV4KCkge1xuICAgIGxldCBiZXN0SW5kZXggPSAtMTtcbiAgICBsZXQgYmVzdERpc3RhbmNlID0gSW5maW5pdHk7XG4gICAgaWYgKHRoaXMudmlld2VyKSB7XG4gICAgICBjb25zdCB2aWV3cG9ydEJvdW5kcyA9IHRoaXMudmlld2VyLnZpZXdwb3J0LmdldEJvdW5kcyh0cnVlKTtcbiAgICAgIGNvbnN0IHZpZXdwb3J0Q2VudGVyID0gdmlld3BvcnRCb3VuZHMuZ2V0Q2VudGVyKCk7XG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5mcmFtZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgZnJhbWUgPSB0aGlzLmZyYW1lc1tpXTtcbiAgICAgICAgaWYgKGZyYW1lLmNvbnRhaW5zUG9pbnQodmlld3BvcnRDZW50ZXIpKSB7XG4gICAgICAgICAgY29uc3QgZGlzdGFuY2UgPSB2aWV3cG9ydENlbnRlci5zcXVhcmVkRGlzdGFuY2VUbyhmcmFtZS5nZXRDZW50ZXIoKSk7XG4gICAgICAgICAgaWYgKGRpc3RhbmNlIDwgYmVzdERpc3RhbmNlKSB7XG4gICAgICAgICAgICBiZXN0RGlzdGFuY2UgPSBkaXN0YW5jZTtcbiAgICAgICAgICAgIGJlc3RJbmRleCA9IGk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBiZXN0SW5kZXg7XG4gICAgfVxuICB9XG5cbiAgZ2V0RnJhbWVDb3VudCgpIHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZXMubGVuZ3RoO1xuICB9XG5cbiAgZ29Ub05leHRGcmFtZSgpIHtcbiAgICBsZXQgaW5kZXggPSB0aGlzLmdldEZyYW1lSW5kZXgoKTtcbiAgICBpZiAoaW5kZXggIT09IHVuZGVmaW5lZCAmJiBpbmRleCA8IHRoaXMuZnJhbWVzLmxlbmd0aCAtIDEpIHtcbiAgICAgIHRoaXMuZ29Ub0ZyYW1lKGluZGV4ICsgMSk7XG4gICAgfVxuICB9XG5cbiAgZ29Ub1ByZXZpb3VzRnJhbWUoKSB7XG4gICAgbGV0IGluZGV4ID0gdGhpcy5nZXRGcmFtZUluZGV4KCk7XG4gICAgaWYgKGluZGV4ICE9PSB1bmRlZmluZWQgJiYgaW5kZXggPiAwKSB7XG4gICAgICB0aGlzLmdvVG9GcmFtZShpbmRleCAtIDEpO1xuICAgIH1cbiAgfVxufVxuIl19"}
